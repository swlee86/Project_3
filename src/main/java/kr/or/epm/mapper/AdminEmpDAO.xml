<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
 	작성자 : 백승아
 	작성일 : 2016-12-08
 	목  적 : 사원관리 전용 mapper
-->
<mapper namespace="kr.or.epm.DAO.AdminEmpDAO">

	<!-- 사원 정보 리스트 출력 -->
	<select id="selectEmp_list" resultType="kr.or.epm.VO.Emp">
		select emp_no, emp_name, branch_name, dept_name, low_dept_name, pic, cg_name, position_name
		from emp e join low_dept l
		on e.low_dept_no = l.low_dept_no
		join emp_cg c
		on e.cg_no = c.cg_no
		join position p
		on e.position_no = p.position_no
		order by branch_name asc, dept_name asc, low_dept_name asc
	</select>
	
	<!-- 사원 등록을 위한 새로운 사번 가져오기 -->
	<select id="selectNew_emp_no" resultType="String">
		select to_char(sysdate, 'yyyy') || trim(to_char(to_number(substr(nvl(max(emp_no),'0'), 5,4))+1, '0000'))
		from emp
		where emp_no != '99999999'
	</select>
	
	<!-- 사원 등록을 위한 근무 상태 리스트 불러오기 -->
	<select id="selectEmp_cg_list" resultType="kr.or.epm.VO.Emp_cg">
		select cg_no, cg_name
		from emp_cg
	</select>
	
	<!-- 사원 등록을 위한 직위 리스트 불러오기 -->
	<select id="selectPosition_list" resultType="kr.or.epm.VO.Position">
		select position_no, position_name
		from position
		order by step asc
	</select>
	
	<!-- 사원 등록을 위한 지점 리스트 불러오기 -->
	<select id="selectBranch_list" resultType="kr.or.epm.VO.Branch">
		select branch_no, branch_name
		from branch
		order by branch_no asc
	</select>
	
	<!-- 사원 등록에서 부서 리스트 불러오기 -->
	<select id="selectDept_list" resultType="kr.or.epm.VO.Dept">
		select dept_no, dept_name
		from dept
		where branch_no = #{branch_no}
    	order by dept_no asc
	</select>
	
	<!-- 사원 등록에서 하위 부서 리스트 불러오기 -->
	<select id="selectLow_dept_list" resultType="kr.or.epm.VO.Low_dept">
		select low_dept_no, low_dept_name
		from low_dept
		where dept_no = #{dept_no}
    	order by low_dept_no asc
	</select>
	
	<!-- 사원 등록하기 -->
	<insert id="insertEmp">
		insert into emp(emp_no, cg_no, position_no, 
						low_dept_no, emp_break, salary, 
						emp_name, birth, cell_phone,
                		pic, email, emp_tel)
		values(#{emp_no}, #{cg_no}, #{position_no}, 
			   #{low_dept_no}, #{emp_break}, #{salary}, 
			   #{emp_name}, #{birth}, #{cell_phone},
       		   null, null, null)
	</insert>
	
	<!-- 사원을 등록하면서 이력에 '입사' 추가하기 -->
	<insert id="insertEmp_his_in">
		insert into emp_his(emp_no, his_no, cg_no, regdate)
		values(#{emp_no}, emp_his_seq.nextval, '1', to_char(sysdate, 'yyy-mm-dd'))
	</insert>
	
	<!-- 사원을 등록하면서 권한에 'none' 추가하기 -->
	<insert id="insertEmp_role_none">
		insert into emp_role(role_no, emp_no)
		values('1', #{emp_no})
	</insert>
	
	<!-- 사원 이력 불러오기 -->
	<select id="selectEmp_his" resultType="kr.or.epm.VO.Emp">
		select e.emp_no, branch_name, dept_name, his_no,
			   low_dept_name, position_name, emp_name, regdate,
			   ec.cg_name, hc.cg_name as "his_cg_name", role_name
		from emp e join emp_role er
		on e.emp_no = er.emp_no
		join role r
		on er.role_no = r.role_no
		join emp_cg ec
		on e.cg_no = ec.cg_no
		join emp_his h
		on e.emp_no = h.emp_no
		join emp_his_cg hc
		on h.cg_no = hc.cg_no
		join position p
		on e.position_no = p.position_no
		join low_dept l
		on e.low_dept_no = l.low_dept_no
		where e.emp_no = #{emp_no}
		order by regdate desc
	</select>
	
	<!-- 탈퇴를 요청한 사원 리스트 불러오기 -->
	<select id="selectEmp_withdrawal" resultType="kr.or.epm.VO.Emp">
		select emp_no, emp_name, position_name, low_dept_name, dept_name, branch_name
		from emp e join position p
		on e.position_no = p.position_no
		join low_dept l
		on e.low_dept_no = l.low_dept_no
		join emp_cg c
		on e.cg_no = c.cg_no
		where e.cg_no = '23'
    	order by emp_no asc
	</select>
	
	<!-- 탈퇴를 요청한 사원의 상세 불러오기  -->
	<select id="selectEmp_withdrawal_detail" resultType="kr.or.epm.VO.Emp">
		select e.emp_no, salary, emp_name, 
			   birth, pic, cell_phone, 
			   emp_tel, branch_name, dept_name, 
			   position_name, low_dept_name, regdate
		from emp e join low_dept l
		on e.low_dept_no = l.low_dept_no
		join emp_his h
		on e.emp_no = h.emp_no
		join position p
		on e.position_no = p.position_no
		where h.cg_no = '1' and
			  e.emp_no = #{emp_no}
	</select>
	
	<!-- 탈퇴시키기 위해 사번의 년도를 0000으로 변경하기 -->
	<update id="updateEmp_no">
		update emp
		set emp_no = '0000'||substr(#{emp_no}, 5,4)
		where emp_no = #{emp_no}
	</update>
	
	<!-- 탈퇴시키기 위해 사원의 권한을 none으로 변경하기 -->
	<update id="updateEmp_role_none">
		update emp_role
		set role_no = '0'
		where emp_no = #{emp_no}
	</update>
	
	<!-- 탈퇴시키기 위해 사원의 이력을 '퇴사'로 변경하기 -->
	<update id="updateEmp_his_out">
		update emp_his
		set cg_no = '2'
		where emp_no = #{emp_no}
	</update>
	
</mapper>