<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.epm.DAO.TaskDAO">

<!--
	작성일 : 2016-11-20
	작성자 : 백승아
	사용 목적 : 업무에 대한 mapper
-->

	<!-- 업무 등록하기 -->
	<!-- task_step_no (2) : 미진행, step_no (4) : 미승인 -->
	<insert id="insertTask" parameterType="kr.or.epm.VO.Task">
		insert into task(task_no, cg_no, sign, 
						 task_name, deadline, content, 
						 rec_emp_no, rec_name, rec_date, 
						 emp_no, emp_name, send_date, 
						 file_name, del_check, rec_del_check, 
						 task_step_no, step_no)
		values(#{task_no}, #{cg_no}, '0', 
			   #{task_name}, #{deadline}, #{content}, 
			   #{rec_emp_no}, #{rec_name}, null, 
			   #{emp_no}, #{emp_name}, to_char(sysdate, 'yyyy-mm-dd'), 
			   #{file_name, jdbcType=VARCHAR}, '0', '0', 
			   '2', '4')
	</insert>
	
	<!-- 업무 중요설정 -->
	<update id="updateTask_sign">
		update task
		set sign = #{sign}
		where task_no = #{task_no}
	</update>
	
	<!-- 업무 수신함 확인하기 / 보낸 날짜가 최신 순서로 정렬 -->
	<select id="selectTask_rec" resultType="kr.or.epm.VO.Task">
		select task_no, cg_name, sign,
       		   task_name, deadline, emp_no,
       		   emp_name, send_date, file_name,
       		   t.step_no, a.step_name, a.step, rec_date
		from task t join task_cg c
		on t.cg_no = c.cg_no
    	join approval a
    	on t.step_no = a.step_no
		where rec_emp_no = #{param1} and 
			  rec_del_check = '0' and 
			  t.cg_no = #{param2}
    	order by a.step desc
	</select>
	
	<!-- 업무 상세 조회하기 -->
	<select id="selectTask_detail" resultType="kr.or.epm.VO.Task">
		select t.task_no, cg_name, sign, 
			   task_name, deadline, content, 
			   rec_emp_no, rec_name, rec_date, 
			   t.emp_no, emp_name, send_date, 
			   file_name, task_step_no, t.step_no,
			   p.emp_no, step_name
		from task t join task_cg c
		on t.cg_no = c.cg_no
    	join approval a
    	on t.step_no = a.step_no
		left outer join task_people p
		on t.task_no = p.task_no
		where t.task_no = #{task_no}
	</select>
	
	
	<!--업무 요청 수신 상세 보기 업무 내용만 있음-->
	<select id="selectTask_receive_detail" resultType="kr.or.epm.VO.Task">
	   select task_no, cg_no, sign, task_name, deadline, content, emp_name, rec_name, emp_no, send_date, file_name, task_step_no, step_no from task where task_no = #{task_no}
	</select>
	
	
	
	
	<!-- 수신함에서 읽었을 때 수신일 데이터 삽입하기 -->
	<update id="updateTask_recDate">
		update task
    	set rec_date = to_char(sysdate, 'yyyy-mm-dd')
    	where task_no = #{task_no}
	</update>

	<!-- 업무 승인 처리하기 -->
	<update id="updateTask_approval">
		update task
		set step_no = #{step_no}
		where task_no = #{task_no}
	</update>
	
	<!-- 수신함에서 삭제하기 -->
	<update id="deleteTask_rec">
		update task
		set rec_del_check = '1'
		where task_no = #{task_no}
	</update>
	
	<!-- 업무 송신함 확인하기 / 보낸 날짜가 최신 순서로 정렬 -->
	<select id="selectTask" resultType="kr.or.epm.VO.Task">
		select task_no, cg_name, task_name, 
			   deadline, rec_emp_no, rec_name, 
			   rec_date, send_date, file_name, 
			   task_step_no, t.step_no, a.step_name, a.step
		from task t join task_cg c 
		on t.cg_no = c.cg_no
    	join approval a
    	on t.step_no = a.step_no
		where emp_no = #{param1} and 
			  del_check = '0' and 
			  t.cg_no = #{param2}
    	order by a.step desc
	</select>
	
	<!-- 송신함에서 삭제하기 -->
	<update id="deleteTask">
		update task
		set del_check = '1'
		where task_no = #{task_no}
	</update>
	
	<!-- 참여 업무 조회하기 / 마감기한이 현재 날짜와 가까운 순서대로 정렬 -->
	<select id="selectTask_people" resultType="kr.or.epm.VO.Task">
		select t.task_no, cg_name, task_name,
      		   deadline, rec_emp_no, rec_name,
       		   t.emp_no, emp_name, file_name, 
       		   task_step_no
		from task t join task_cg c
		on t.cg_no = c.cg_no
		left outer join (select task_no, emp_no
                 		 from task_people
                 		 where emp_no = #{emp_no}) p
		on t.task_no = p.task_no
		where t.step_no = '1' and
          t.cg_no = '1' and
          rec_emp_no = #{emp_no} or
          p.emp_no is not null
		order by abs(trunc(to_date(deadline) - to_date(to_char(sysdate, 'yyyy-mm-dd')))) asc
	</select>
	
	<!-- 참여 업무 진행 처리하기 -->
	<update id="updateTask_step">
		update task
		set task_step_no = #{param2}
		where task_no = #{param1}
	</update>
	
	<!-- 수신 글 개수 구하기 -->
	<select id="countTask_rec" resultType="Integer">
		select count(task_no)
		from task
		where cg_no = #{param2} and rec_emp_no = #{param1} and rec_del_check = '0'
	</select>
	
	<!-- 송신 글 개수 구하기 -->
	<select id="countTask" resultType="Integer">
		select count(task_no)
		from task
		where cg_no = #{param2} and emp_no = #{param1} and del_check = '0'
	</select>
	
	<!-- 수신함에서 검색하기 -->
	<select id="searchTask" resultType="kr.or.epm.VO.Task">
		select task_no, cg_name, sign,
       		   task_name, deadline, emp_no,
       		   emp_name, send_date, file_name,
       		   t.step_no, a.step_name, a.step, rec_date
		from task t join task_cg c
		on t.cg_no = c.cg_no
    	join approval a
    	on t.step_no = a.step_no
		where rec_emp_no = #{param1} and 
			  rec_del_check = '0' and 
			  t.cg_no = #{param2} and
        	  ${param3} like '%${param4}%'
    	order by a.step desc
	</select>
	
	<!-- 수신함에서 검색한 글의 개수 구하기 -->
	<select id="countTask_search" resultType="Integer">
		select count(task_no)
		from task t join task_cg c
		on t.cg_no = c.cg_no
		where rec_emp_no = #{param1} and 
			  rec_del_check = '0' and 
			  t.cg_no = #{param2} and
        	  #{param3} like '%${param4}%'
    	order by a.step desc
	</select>

	<!--내게 참조한 모든 업무 보기-->
	<select id="selectTask_people_ForMe" resultType="kr.or.epm.VO.Task_people">
		  select Task_NO, EMP_NO from task_people where emp_no = #{emp_no}
	</select>

</mapper>
