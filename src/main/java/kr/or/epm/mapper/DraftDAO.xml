<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.epm.DAO.DraftDAO">
<!-- 	
	현재 로그인한 사원에게 온 전자결재 조회 ( 수신결재함 조회 ) / 정렬순서는 미승인을 위로
	<select id="selectDraft_rec" resultType="kr.or.epm.VO.Draft">
		select draft_no, d.cg_no, cg_name, draft_title, draft_content, 
		       emp_no, draft_date, file_name, d.step_no, step_name, 
		       step, rec_del_check, del_check 
		from draft d 
		join form_cg f 
			on d.cg_no = f.cg_no
		join approval a 
			on d.step_no = a.step_no
		where d.draft_no in 
		  (select draft_no from draft_line where emp_no=#{emp_no}) 
		and rec_del_check=0
		order by step_no desc
	</select>
	
	승인자가 승인처리
	<update id="approveDraftLine" parameterType="kr.or.epm.VO.Draft">
		update draft_line 
			set app_check=1, 
				app_date=to_char(sysdate,'yyyy-mm-dd')
		where draft_no=#{draft_no} and emp_no=#{emp_no}
	</update>
	
	결재 문서 별 승인처리 , 최종승인
	<update id="approveDraft" parameterType="kr.or.epm.VO.Draft">
		update draft 
			set step_no=(select step_no from approval where step_name='승인') 
		where draft_no=#{draft_no}
	</update>
	
	
	수신된 전자결재문서 상세보기(대외발신공문)
	<select id="selectOffice" resultType="kr.or.epm.VO.Office">
		select d.draft_no, rec_place, rec_fax, rec_person, rec_tel, 
			   rec_postcode, rec_addr, rec_addr_detail, cg_no, draft_title,
         		draft_content, emp_no, draft_date, file_name, 
         		step_no, rec_del_check, del_check
		from office o 
		join draft d 
			on d.draft_no = o.draft_no 
		where d.draft_no=#{draft_no}
	</select>
	
	
	수신된 전자결재문서 상세보기(휴가신청)
	<select id="selectBreak" resultType="kr.or.epm.VO.Break">
		select d.draft_no, break_start, break_end, break_term, 
			   b.break_cg_no, break_cg_name,cg_no, draft_title,
         		draft_content, emp_no, draft_date, file_name, step_no, 
         		rec_del_check, del_check 
		from break b 
		join break_cg c 
			on b.break_cg_no = c.break_cg_no 
   		join draft d
      		on d.draft_no = b.draft_no
		where d.draft_no=#{draft_no}
	</select>
	
	수신된 전자결재문서 상세보기(협조문)
	<select id="selectCooperation" resultType="kr.or.epm.VO.Cooperation">
		select d.draft_no, c.low_dept_no, dept_no, branch_name, 
			   dept_name, low_dept_name, tel, fax, 
			   pre_low_dept_no, his_check, depth,
	           cg_no, draft_title,draft_content, emp_no, 
	           draft_date, file_name, step_no, rec_del_check, del_check
		from cooperation c 
		join low_dept l 
			on c.low_dept_no = l.low_dept_no 
		join draft d
	    	on d.draft_no = c.draft_no
	    where d.draft_no=#{draft_no}
	</select>
	
	수신에서 삭제처리
	<update id="deleteDraft_rec" parameterType="kr.or.epm.VO.Draft">
		update draft 
			set rec_del_check =1
		where draft_no=#{draft_no}
	</update>
	
	송신에서 삭제처리
	<update id="deleteDraft" parameterType="kr.or.epm.VO.Draft">
		update draft 
			set del_check =1
		where draft_no=#{draft_no}
	</update>
	
	송신결재함 조회
	<select id="selectDraft" resultType="kr.or.epm.VO.Draft">
		select draft_no, d.cg_no, cg_name, draft_title, draft_content, 
	       	   emp_no, draft_date, file_name, d.step_no, step_name, 
	       	   step, rec_del_check, del_check
		from draft d join form_cg f 
						on d.cg_no=f.cg_no 
					 join approval a 
					 	on d.step_no = a.step_no 
		where emp_no=#{emp_no} 
		and del_check=0 
		order by d.step_no desc
	</select>
	
	
	결재라인 진행 현황
	<select id="selectDraftLine" resultType="kr.or.epm.VO.Draft_line">
		select draft_no, l.emp_no,app_check, app_date, e.position_no, 
			   position_name,step, low_dept_no, salary, emp_name, birth, 
			   pic, email, cell_phone, emp_tel, emp_break,cg_no 
		from draft_line l join emp e 
							on l.emp_no=e.emp_no 
						  join position p 
						  	on e.position_no = p.position_no 
		where l.draft_no=#{draft_no} 
		order by position_no desc
	</select>
	
	
	결재라인에서  내가 포함된 미승인 결제들의 draft_no 목록 불러오기(내 차례인것만)
	<select id="selectDraftLine_myturn" parameterType="String" resultType="String">
		select draft_no 
		from (select rownum, r.*
		      from (select l.emp_no, draft_no, app_check,e.position_no,p.step
		            from draft_line l 
		            join emp e on l.emp_no=e.emp_no
		            join position p on e.position_no = p.position_no
		            where draft_no 
		            in (select draft_no 
		                from draft d 
		                join approval a on d.step_no=a.step_no 
		                where step_name='미승인') 
		            order by p.step desc) r
		      where app_check=0 and rownum in 1 ) s
		where s.emp_no=#{emp_no}
	</select>
	 -->
	
	
	<!-- 전자결재 등록하기 -->
	<insert id="insertDraft">
		insert into draft(draft_no, cg_no, 
						  draft_title, draft_content, emp_no, 
						  draft_date, file_name, del_check, 
						  rec_del_check, step_no)
		values(draft_seq.nextval, #{cg_no},
			   #{draft_title}, #{draft_content}, #{emp_no},
			   #{draft_date}, #{file_name, jdbcType=VARCHAR}, '0',
			   '0', '4')
	</insert>
	
	<!-- 대외발신공문 등록하기 -->
	<insert id="insertOffice">
		insert into office(draft_no, rec_place, rec_fax, 
						   rec_person, rec_tel, rec_postcode,
						   rec_addr, rec_addr_detail)
		values(draft_seq.currval, #{rec_place, jdbcType=VARCHAR}, #{rec_fax, jdbcType=VARCHAR},
			   #{rec_person, jdbcType=VARCHAR}, #{rec_tel, jdbcType=VARCHAR}, #{rec_postcode, jdbcType=VARCHAR},
			   #{rec_addr, jdbcType=VARCHAR}, #{rec_addr_detail, jdbcType=VARCHAR})
	</insert>
	
	<!-- 결재 번호 가져오기 -->
	<select id="selectDraft_noList" resultType="String">
		select draft_no
		from draft
	</select>
	
	<!-- 결재라인 차례 확인하기 -->
	<select id="selectDraft_line" resultType="String">
		select z.draft_no
		from (select draft_no, l.emp_no, e.emp_name, p.position_name, p.step, app_check, app_date
			  from draft_line l join emp e
			  on l.emp_no = e.emp_no
		      join position p
			  on e.position_no = p.position_no
			  where app_check = '0' and
      				draft_no = #{param1}
      		  order by step desc) z join draft d
		on z.draft_no = d.draft_no
		where rownum = '1' and
      		  z.emp_no = #{param2} and
      		  cg_no = #{param3}
	</select>
	
	<!-- 대외발신공문 수신 리스트 -->
	<select id="selectOffice_rec" resultType="kr.or.epm.VO.Office">
		select d.draft_no, d.cg_no, draft_title, d.emp_no, draft_date, file_name, del_check, rec_del_check, step_no, 
  			   e.emp_name, rec_place, rec_addr, rec_check
		from draft d join office o
		on d.draft_no = o.draft_no
    	join emp e
    	on d.emp_no = e.emp_no
      	join draft_line l
      	on d.draft_no = l.draft_no
		where d.draft_no = #{param1} and l.emp_no = #{param2}
	</select>
	
	<!-- 협조문 수신 리스트 -->
	<select id="selectCooperation_rec" resultType="kr.or.epm.VO.Cooperation">
		select d.draft_no, d.cg_no, draft_title, d.emp_no, draft_date, file_name, del_check, rec_del_check, step_no,
           	   e.emp_name, low_dept_name, dept_name, branch_name, rec_check
		from draft d join cooperation c
		on d.draft_no = c.draft_no
    	join emp e
    	on d.emp_no = e.emp_no
    	join low_dept l
   	 	on l.low_dept_no = c.low_dept_no
      	join draft_line n
      	on d.draft_no = n.draft_no
		where d.draft_no = #{param1} and n.emp_no = #{param2}
	</select>
	
	<!-- 휴가신청서 수신 리스트 -->
	<select id="selectBreak_rec" resultType="kr.or.epm.VO.Break">
		select d.draft_no, d.cg_no, draft_title, d.emp_no, draft_date, file_name, del_check, rec_del_check, step_no,
         	   break_term, break_cg_name, e.emp_name, rec_check
		from draft d join break b
		on d.draft_no = b.draft_no
		join break_cg c
		on b.break_cg_no = c.break_cg_no
    	join emp e
    	on d.emp_no = e.emp_no
      	join draft_line l
      	on d.draft_no = l.draft_no
		where d.draft_no = #{param1} and l.emp_no = #{param2}
	</select>
	
	<!-- 대외발신공문 송신 리스트 -->
	<select id="selectOffice" resultType="kr.or.epm.VO.Office">
		select d.draft_no, cg_no, draft_title, draft_date, step_no, rec_place, rec_addr
		from draft d join office o
		on d.draft_no = o.draft_no
		where emp_no = #{emp_no} and del_check = '0'
	</select>
	
	<!-- 협조문 송신 리스트 -->
	<select id="selectCooperation" resultType="kr.or.epm.VO.Cooperation">
		select d.draft_no, cg_no, draft_title, draft_date, step_no, low_dept_name, dept_name, branch_name
		from draft d join cooperation c
		on d.draft_no = c.draft_no
		join low_dept l
		on c.low_dept_no = l.low_dept_no 
		where emp_no = #{emp_no} and del_check = '0'
	</select>
	
	<!-- 휴가신청서 송신 리스트 -->
	<select id="selectBreak" resultType="kr.or.epm.VO.Break">
		select d.draft_no, cg_no, draft_title, draft_date, step_no, break_term, break_cg_name
		from draft d join break b
		on d.draft_no = b.draft_no
		join break_cg c
		on b.break_cg_no = c.break_cg_no
		where emp_no = #{emp_no} and del_check ='0'
	</select>
	
	<!-- 대외발신공문 상세 -->
	<select id="selectOffice_detail" resultType="kr.or.epm.VO.Office">
		select d.draft_no, rec_place, rec_fax, rec_person, rec_tel, 
			   rec_postcode, rec_addr, rec_addr_detail, d.cg_no, draft_title,
         	   draft_content, d.emp_no, draft_date, file_name, 
         	   low_dept_name, dept_name, branch_name, step_no, e.emp_name
		from office o 
		join draft d 
		on d.draft_no = o.draft_no
    	join emp e
    	on d.emp_no = e.emp_no
    	join low_dept l
    	on e.low_dept_no = l.low_dept_no 
		where d.draft_no = #{draft_no}
	</select>
	
	<!-- 협조문 상세 -->
	<select id="selectCooperation_detail" resultType="kr.or.epm.VO.Cooperation">
		select d.draft_no, d.cg_no, draft_title, draft_content, d.emp_no, draft_date, file_name, step_no,
       		   c.branch_no, c.dept_no, c.low_dept_no,
       		   e.emp_name, l.branch_name, l.dept_name, l.low_dept_name
		from draft d join cooperation c
		on d.draft_no = c.draft_no
		join emp e
		on d.emp_no = e.emp_no
		join low_dept l 
		on e.low_dept_no = l.low_dept_no
		where d.draft_no = #{draft_no}
	</select>
	
	<!-- 휴가 신청서 상세 -->
	<select id="selectBreak_detail">
		select d.draft_no, d.cg_no, draft_title, draft_content, d.emp_no, draft_date, file_name, step_no,
       	   	   break_start, break_end, break_term, break_cg_name,
       		   e.emp_name, l.branch_name, l.dept_name, l.low_dept_name
		from draft d join break b
		on d.draft_no = b.draft_no
		join break_cg c
		on b.break_cg_no = c.break_cg_no
		join emp e
		on d.emp_no = e.emp_no
		join low_dept l 
		on e.low_dept_no = l.low_dept_no
		where d.draft_no = #{draft_no}
	</select>
	
	<!-- 결재라인 정보 가져오기 -->
	<select id="selectDraft_line_data" resultType="kr.or.epm.VO.Draft_line">
		select draft_no, l.emp_no, app_check, app_date, rec_check, emp_name
		from draft_line l join emp e
    	on l.emp_no = e.emp_no
		where draft_no = #{draft_no}
	</select>
	
	<!-- 참조자 정보 가져오기 -->
	<select id="selectDraft_ref_data" resultType="kr.or.epm.VO.Draft_ref">
		select draft_no, r.emp_no, emp_name
		from draft_ref r join emp e
    	on r.emp_no = e.emp_no
		where draft_no = #{draft_no}
	</select>
</mapper>